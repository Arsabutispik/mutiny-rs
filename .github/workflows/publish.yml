name: Publish to Crates.io

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  publish:
    name: Publish Crate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # 3. Generate Release Notes (for the GitHub UI)
      - name: Generate Release Notes
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          # --latest: Extract only the changes for the current tag
          # --strip header: Remove the "Changelog" title
          args: --latest --strip header
        env:
          OUTPUT: RELEASE_NOTES.md # Temp file, not the main changelog
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4. Publish to Crates.io
      - name: Publish to Crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        # We keep --allow-dirty just in case the RELEASE_NOTES.md file
        # confuses cargo, though usually it's ignored.
        run: cargo publish --allow-dirty

      # 5. Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}